<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">

    <!-- MODIFICADO: Usar arquivos KaTeX locais -->
    <!-- Certifique-se de que katex.min.css, katex.min.js e a pasta 'fonts' (do pacote KaTeX)
         estejam na sua pasta 'assets' do Android -->
    <link rel="stylesheet" href="katex.min.css">
    <script defer src="katex.min.js"></script>

    <style>
        body {
            margin: 8px;
            font-size: 1.1em;
            overflow-x: hidden;
        }
        #formula-container {
            overflow-x: auto;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
<div id="formula-container"></div>

<script type="text/javascript">
    // MODIFICADO: Adicionados logs para depuração
    console.log("KaTeX_HTML: Script block started.");

    // Verifica se KaTeX está definido logo após o script ser (supostamente) carregado
    // Este log pode não ser 100% confiável devido ao 'defer', mas é um bom indicador.
    // Para uma verificação mais precisa, o ideal seria um callback onload do script KaTeX se disponível,
    // ou verificar dentro de um evento como DOMContentLoaded.
    document.addEventListener('DOMContentLoaded', (event) => {
        if (typeof katex !== 'undefined') {
            console.log("KaTeX_HTML: KaTeX object IS defined on DOMContentLoaded.");
        } else {
            console.warn("KaTeX_HTML: KaTeX object IS NOT defined on DOMContentLoaded. CHECK SCRIPT PATHS AND LOADING.");
        }
    });


    function displayFormula(latexString) {
        console.log("KaTeX_HTML: displayFormula called with: \"" + latexString + "\"");
        const container = document.getElementById('formula-container');

        if (typeof katex === 'undefined') {
            console.error("KaTeX_HTML: KaTeX is UNDEFINED inside displayFormula! Cannot render.");
            if (container) {
                container.innerHTML = "Erro crítico: Biblioteca KaTeX não carregada.<br>String LaTeX: <pre>" + escapeHtml(latexString) + "</pre>";
            }
            return; // Sai da função se KaTeX não estiver carregado
        }

        if (container) {
            try {
                katex.render(latexString, container, {
                    throwOnError: false,
                    displayMode: true,
                    output: "html"
                });
                console.log("KaTeX_HTML: KaTeX render successful for: \"" + latexString + "\"");
            } catch (e) {
                // O erro já está sendo tratado pela opção throwOnError: false do KaTeX,
                // que mostra o erro no próprio container.
                // Mas podemos logar adicionalmente.
                container.innerHTML = "Erro ao renderizar LaTeX: " + e.message +
                                      "<br>String LaTeX: <pre>" + escapeHtml(latexString) + "</pre>";
                console.error("KaTeX_HTML: KaTeX.render Error:", e);
                console.error("KaTeX_HTML: Problematic LaTeX string for render error:", latexString);
            }
        } else {
            console.error("KaTeX_HTML: Elemento 'formula-container' não encontrado.");
        }
    }

    function clearFormula() {
        console.log("KaTeX_HTML: clearFormula called.");
        const container = document.getElementById('formula-container');
        if (container) {
            container.innerHTML = '';
        }
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

</script>
</body>
</html>

